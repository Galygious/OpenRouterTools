// OpenRouter Model Selection and Chat Interface

document.addEventListener('DOMContentLoaded', () => {
  // Initialize Select2
  $('.select2').select2({
    width: '100%',
    theme: 'classic',
    placeholder: function() {
      return $(this).data('placeholder') || $(this).find('option:first').text();
    }
  });

  // Constants
  const OPENROUTER_API = {
    BASE_URL: 'https://openrouter.ai/api',
    MODELS_ENDPOINT: '/v1/models'
  };

  // DOM Element References
  const apiKey = document.getElementById('api-key');
  const saveKeyBtn = document.getElementById('save-key');
  const statsTab = document.getElementById('stats-tab');
  const chatTab = document.getElementById('chat-tab');
  const statsView = document.getElementById('stats-view');
  const chatView = document.getElementById('chat-view');
  
  // Stats View Elements
  const modelInput = document.getElementById('model-input');
  const fetchButton = document.getElementById('fetch-button');
  const fetchAllButton = document.getElementById('fetch-all-button');
  const suggestionsContainer = document.getElementById('suggestions');
  const errorMessage = document.getElementById('error-message');
  const loadingIndicator = document.getElementById('loading');
  const statsTable = document.getElementById('stats-table').querySelector('tbody');

  // Model Selection Dropdowns
  const creatorDropdown = $('#creator-dropdown');
  const modelDropdown = $('#model-dropdown');
  const versionDropdown = $('#version-dropdown');
  const providerDropdown = $('#provider-dropdown');

  // Model Details Elements
  const pricingPrompt = document.getElementById('prompt-price');
  const pricingCompletion = document.getElementById('completion-price');
  const modelDescription = document.getElementById('model-description');

  // State Management
  let modelData = [];
  let apiKeyValue = localStorage.getItem('openrouter_api_key');

  // API Key Management
  if (apiKeyValue) {
    apiKey.value = apiKeyValue;
  }

  saveKeyBtn.addEventListener('click', () => {
    const key = apiKey.value.trim();
    if (!key) {
      showError('Please enter an API key');
      return;
    }
    localStorage.setItem('openrouter_api_key', key);
    apiKeyValue = key;
    fetchModelData();
  });

  // API Utilities
  async function fetchWithAuth(url, options = {}) {
    if (!apiKeyValue) {
      throw new Error('API key is required');
    }

    const headers = {
      'Authorization': `Bearer ${apiKeyValue}`,
      'HTTP-Referer': window.location.origin,
      ...options.headers
    };

    const response = await fetch(url, { ...options, headers });
    
    if (!response.ok) {
      if (response.status === 401) {
        localStorage.removeItem('openrouter_api_key');
        throw new Error('Invalid API key');
      }
      throw new Error(`API request failed: ${response.statusText}`);
    }

    return response.json();
  }

  function showError(message) {
    errorMessage.textContent = message;
    errorMessage.classList.remove('hidden');
    setTimeout(() => {
      errorMessage.classList.add('hidden');
    }, 5000);
  }

  function showLoading(show = true) {
    loadingIndicator.classList.toggle('hidden', !show);
  }

  // Model Data Management
  async function fetchModelData() {
    showLoading(true);
    errorMessage.classList.add('hidden');
    statsTable.innerHTML = '';

    try {
      const response = await fetchWithAuth(`${OPENROUTER_API.BASE_URL}${OPENROUTER_API.MODELS_ENDPOINT}`);
      console.log('API Response:', response);
      modelData = response.data || [];
      
      // Process model data to ensure all required fields
      modelData = modelData.map(model => ({
        ...model,
        provider: model.provider || model.endpoint?.provider_name,
        name: model.name || model.short_name,
        version: model.version || 'default'
      }));
      
      console.log('Processed Model Data:', modelData);
      populateCreatorDropdown();
      setupModelSearch();
    } catch (error) {
      console.error('Error fetching model data:', error);
      console.log('API response error:', error); // Added log
      showError(error.message);
    } finally {
      showLoading(false);
    }
  }

  function setupModelSearch() {
    modelInput.addEventListener('input', () => {
      const searchTerm = modelInput.value.toLowerCase();
      if (searchTerm.length < 2) {
        suggestionsContainer.classList.add('hidden');
        return;
      }

      const matches = modelData.filter(model => 
        model.id?.toLowerCase().includes(searchTerm) ||
        model.name?.toLowerCase().includes(searchTerm)
      );

      suggestionsContainer.innerHTML = '';
      matches.slice(0, 5).forEach(model => {
        const li = document.createElement('li');
        li.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-base';
        li.textContent = `${model.name} (${model.id})`;
        li.addEventListener('click', () => {
          modelInput.value = model.id;
          suggestionsContainer.classList.add('hidden');
          fetchModelStats(model.id);
        });
        suggestionsContainer.appendChild(li);
      });
      suggestionsContainer.classList.remove('hidden');
    });
  }

  async function fetchModelStats(modelId) {
    showLoading(true);
    errorMessage.classList.add('hidden');
    statsTable.innerHTML = '';

    try {
      const model = modelData.find(m => m.id === modelId);
      if (!model) {
        throw new Error('Model not found');
      }

      const row = document.createElement('tr');
      row.className = 'hover:bg-gray-50 text-base';
      row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap">${model.id || '-'}</td>
        <td class="px-6 py-4 whitespace-nowrap">${model.provider || '-'}</td>
        <td class="px-6 py-4 whitespace-nowrap">${model.context_length || '-'}</td>
        <td class="px-6 py-4 whitespace-nowrap">${model.max_completion_tokens || '-'}</td>
        <td class="px-6 py-4 whitespace-nowrap">${model.pricing?.prompt || '-'}</td>
        <td class="px-6 py-4 whitespace-nowrap">${model.pricing?.completion || '-'}</td>
        <td class="px-6 py-4 whitespace-nowrap">${model.latency?.avg?.toFixed(2) || '-'}</td>
        <td class="px-6 py-4 whitespace-nowrap">${model.throughput?.toFixed(2) || '-'}</td>
      `;
      statsTable.appendChild(row);
    } catch (error) {
      showError(error.message);
    } finally {
      showLoading(false);
    }
  }

  async function fetchAllStats() {
    showLoading(true);
    errorMessage.classList.add('hidden');
    statsTable.innerHTML = '';

    try {
      modelData.forEach(model => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 text-base';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">${model.id || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap">${model.provider || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap">${model.context_length || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap">${model.max_completion_tokens || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap">${model.pricing?.prompt || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap">${model.pricing?.completion || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap">${model.latency?.avg?.toFixed(2) || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap">${model.throughput?.toFixed(2) || '-'}</td>
        `;
        statsTable.appendChild(row);
      });
    } catch (error) {
      showError('Failed to fetch all stats');
    } finally {
      showLoading(false);
    }
  }

  // Event Listeners for Stats View
  fetchButton.addEventListener('click', () => {
    const modelId = modelInput.value.trim();
    if (modelId) {
      fetchModelStats(modelId);
    } else {
      showError('Please enter a model name');
    }
  });

  fetchAllButton.addEventListener('click', fetchAllStats);

  function populateCreatorDropdown() {
    console.log('Populating creators from:', modelData);
    const creators = [...new Set(modelData.map(model => model.provider))].filter(Boolean);
    creators.sort();

    creatorDropdown.empty().append('<option value="">Select a provider...</option>');
    creators.forEach(creator => {
      creatorDropdown.append(new Option(creator, creator));
    });

    creatorDropdown.off('change').on('change', handleCreatorSelection);
    console.log('Creator dropdown options:', creatorDropdown.children().length, creatorDropdown.children().map(function() { return this.text; }).get());
  }

  function handleCreatorSelection() {
    const selectedCreator = creatorDropdown.val();
    console.log('Selected Creator:', selectedCreator);
    
    // Reset and disable subsequent dropdowns
    modelDropdown.empty().append('<option value="">Select a model...</option>').prop('disabled', true);
    versionDropdown.empty().append('<option value="">Select a version...</option>').prop('disabled', true);
    providerDropdown.empty().append('<option value="">Select a configuration...</option>').prop('disabled', true);

    if (!selectedCreator) return;

    const creatorModels = modelData.filter(model => model.provider === selectedCreator);
    console.log('Creator Models:', creatorModels);
    
    // Group models by name to handle different versions
    const modelGroups = creatorModels.reduce((groups, model) => {
      const name = model.name;
      if (!groups[name]) {
        groups[name] = [];
      }
      groups[name].push(model);
      return groups;
    }, {});

    const uniqueModels = Object.keys(modelGroups).sort();
    uniqueModels.forEach(modelName => {
      modelDropdown.append(new Option(modelName, modelName));
    });

    modelDropdown.prop('disabled', false).trigger('change');
  }

  function handleModelSelection() {
    const selectedCreator = creatorDropdown.val();
    const selectedModel = modelDropdown.val();
    console.log('Selected Model:', selectedModel);
    
    // Reset and disable subsequent dropdowns
    versionDropdown.empty().append('<option value="">Select a version...</option>').prop('disabled', true);
    providerDropdown.empty().append('<option value="">Select a configuration...</option>').prop('disabled', true);

    if (!selectedModel) return;

    const modelVersions = modelData.filter(model => 
      model.provider === selectedCreator && 
      model.name === selectedModel
    );
    console.log('Model Versions:', modelVersions);

    // Group versions
    const versions = [...new Set(modelVersions.map(model => model.version))].filter(Boolean);
    versions.sort();
    
    if (versions.length === 0) {
      versions.push('default');
    }

    versions.forEach(version => {
      versionDropdown.append(new Option(version, version));
    });

    versionDropdown.prop('disabled', false).trigger('change');
  }

  function handleVersionSelection() {
    const selectedCreator = creatorDropdown.val();
    const selectedModel = modelDropdown.val();
    const selectedVersion = versionDropdown.val();
    console.log('Selected Version:', selectedVersion);
    
    providerDropdown.empty().append('<option value="">Select a configuration...</option>').prop('disabled', true);

    if (!selectedVersion) return;

    const configurations = modelData.filter(model => 
      model.provider === selectedCreator &&
      model.name === selectedModel &&
      (model.version === selectedVersion || (!model.version && selectedVersion === 'default'))
    );
    console.log('Available Configurations:', configurations);

    if (configurations.length > 0) {
      configurations.sort((a, b) => (a.pricing?.prompt || 0) - (b.pricing?.prompt || 0));
      
      configurations.forEach(config => {
        const optionText = `${config.provider} - $${config.pricing?.prompt || '0'}/prompt, $${config.pricing?.completion || '0'}/completion`;
        providerDropdown.append(new Option(optionText, config.id));
      });

      providerDropdown.prop('disabled', false).trigger('change');
    }
  }

  function handleProviderSelection() {
    const selectedConfig = providerDropdown.val();
    if (!selectedConfig) return;

    const selectedModelEntry = modelData.find(model => model.id === selectedConfig);
    if (selectedModelEntry) {
      pricingPrompt.textContent = `Prompt Price: $${selectedModelEntry.pricing?.prompt || '0'} per token`;
      pricingCompletion.textContent = `Completion Price: $${selectedModelEntry.pricing?.completion || '0'} per token`;
      modelDescription.textContent = selectedModelEntry.description || 'No description available.';
    }
  }

  // Initialize Select2 event handlers
  modelDropdown.off('change').on('change', handleModelSelection);
  versionDropdown.off('change').on('change', handleVersionSelection);
  providerDropdown.off('change').on('change', handleProviderSelection);

  // Tab Navigation
  statsTab.addEventListener('click', () => {
    statsTab.classList.add('active', 'bg-blue-500', 'text-white');
    chatTab.classList.remove('active', 'bg-blue-500', 'text-white');
    statsView.classList.remove('hidden');
    chatView.classList.add('hidden');
    statsTab.setAttribute('aria-pressed', 'true');
    chatTab.setAttribute('aria-pressed', 'false');
  });

  chatTab.addEventListener('click', () => {
    chatTab.classList.add('active', 'bg-blue-500', 'text-white');
    statsTab.classList.remove('active', 'bg-blue-500', 'text-white');
    chatView.classList.remove('hidden');
    statsView.classList.add('hidden');
    chatTab.setAttribute('aria-pressed', 'true');
    statsTab.setAttribute('aria-pressed', 'false');
  });

  // Initialize if API key exists
  if (apiKeyValue) {
    fetchModelData();
  }
});
